{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block content %}

<!-- KPI Cards -->
<div class="grid-4" style="margin-bottom:20px;">
  <div class="card">
    <h4 style="margin:0 0 8px 0; font-size:13px; color:var(--muted);">Tổng số lớp</h4>
    <div class="value" id="stat-total-classes" style="font-size:28px; font-weight:700; color:#2563eb;">-</div>
  </div>
  <div class="card">
    <h4 style="margin:0 0 8px 0; font-size:13px; color:var(--muted);">Số phòng sử dụng</h4>
    <div class="value" id="stat-total-rooms" style="font-size:28px; font-weight:700; color:#059669;">-</div>
  </div>
  <div class="card">
    <h4 style="margin:0 0 8px 0; font-size:13px; color:var(--muted);">Số môn học</h4>
    <div class="value" id="stat-total-courses" style="font-size:28px; font-weight:700; color:#dc2626;">-</div>
  </div>
  <div class="card">
    <h4 style="margin:0 0 8px 0; font-size:13px; color:var(--muted);">Tỉ lệ lấp đầy</h4>
    <div class="value" id="stat-fill-rate" style="font-size:28px; font-weight:700; color:#ea580c;">-</div>
  </div>
</div>

<!-- Lịch hôm nay (cá nhân) -->
<div class="panel" style="margin-bottom:20px;">
  <h3 style="margin:0 0 16px 0;">Lịch hôm nay (cá nhân)</h3>
  <div id="today-schedule" style="display:grid; gap:8px;"></div>
  <p id="today-note" style="color:var(--muted); margin-top:8px; font-size:12px;"></p>
</div>

<!-- Tổng quan tuần (cá nhân) -->
<div class="panel" style="margin-bottom:20px;">
  <h3 style="margin:0 0 16px 0;">Tổng quan tuần (cá nhân)</h3>
  <div id="weekly-summary" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
</div>

<!-- Quick Actions -->
<div class="panel" style="margin-bottom:20px;">
  <h3 style="margin:0 0 16px 0;">Thao tác nhanh</h3>
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <button class="btn" id="btnRunSchedule" style="padding:16px 24px; font-size:16px;">
      <i class="bi bi-cpu" style="margin-right:8px;"></i>Chạy sắp xếp TKB
    </button>
    <button class="btn secondary" id="btnRunRecommend" style="padding:16px 24px; font-size:16px;">
      <i class="bi bi-magic" style="margin-right:8px;"></i>Chạy gợi ý lớp
    </button>
    <button class="btn secondary" id="btnRunRecommendSchedule" style="padding:16px 24px; font-size:16px;">
      <i class="bi bi-calendar2-check" style="margin-right:8px;"></i>Tạo TKB gợi ý
    </button>
  </div>
  
  <!-- Job Status (chỉ hiện khi có job) -->
  <div id="job-section" style="display:none; margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
    <div style="display:grid; gap:8px;">
      <label for="jobId">Job ID</label>
      <div style="display:flex; gap:8px;">
        <input id="jobId" placeholder="Dán job_id" style="flex:1;" />
        <button class="btn secondary" id="btnPoll">Poll</button>
      </div>
      <pre id="jobStatus" style="white-space: pre-wrap; background:var(--panel); color:var(--text); padding:12px; max-height:200px; overflow:auto; font-size:12px;"></pre>
    </div>
  </div>
</div>

<!-- Top Recommendations -->
<div class="panel" style="margin-bottom:20px;">
  <h3 style="margin:0 0 16px 0;">Top gợi ý AI</h3>
  <div id="top-recommendations" style="display:grid; gap:8px;">
    <p style="color:var(--muted); font-size:14px;">Đang tải...</p>
  </div>
</div>

<!-- Quick Links -->
<div class="panel">
  <h3 style="margin:0 0 16px 0;">Xem thời khoá biểu</h3>
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <a class="btn secondary" href="/timetable/school" style="padding:12px 20px;">
      <i class="bi bi-building" style="margin-right:8px;"></i>TKB Toàn trường
    </a>
    <a class="btn secondary" href="/timetable/student" style="padding:12px 20px;">
      <i class="bi bi-person" style="margin-right:8px;"></i>TKB Cá nhân (Học sinh)
    </a>
    <a class="btn secondary" href="/timetable/teacher" style="padding:12px 20px;">
      <i class="bi bi-person-badge" style="margin-right:8px;"></i>TKB Cá nhân (Giáo viên)
    </a>
  </div>
</div>

<script>
  // Load stats
  async function loadStats() {
    try {
      const res = await fetch('/api/stats');
      const stats = await res.json();
      
      // Update KPI cards
      document.getElementById('stat-total-classes').textContent = stats.total_classes || 0;
      document.getElementById('stat-total-rooms').textContent = stats.total_rooms || 0;
      document.getElementById('stat-total-courses').textContent = stats.total_courses || 0;
      
      // Fill rate
      const fillRate = stats.total_slots > 0 ? 
        Math.round((stats.filled_slots / stats.total_slots) * 100) : 0;
      document.getElementById('stat-fill-rate').textContent = fillRate + '%';
      
      // Personal stats (today + week)
      try {
        const resP = await fetch('/api/personal_stats');
        const ps = await resP.json();
        const todayWrap = document.getElementById('today-schedule');
        const todayNote = document.getElementById('today-note');
        const daysOrder = ['Mon','Tue','Wed','Thu','Fri','Sat'];
        const dayNames = {'Mon': 'Thứ 2', 'Tue': 'Thứ 3', 'Wed': 'Thứ 4', 'Thu': 'Thứ 5', 'Fri': 'Thứ 6', 'Sat': 'Thứ 7'};

        // Hôm nay
        if (ps.has_data && ps.today && ps.today.length) {
          todayWrap.innerHTML = ps.today.map(item => `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:10px; border:1px solid var(--border); background:var(--panel); border-radius:8px;">
              <div style="font-weight:700; color:#1e40af; min-width:90px;">${item.time}</div>
              <div style="flex:1; padding:0 8px;">${item.subject || ''}</div>
              <div style="color:var(--muted); min-width:80px; text-align:right;">${item.room || ''}</div>
            </div>
          `).join('');
          todayNote.textContent = `Nguồn dữ liệu: ${ps.source}`;
        } else {
          todayWrap.innerHTML = '<p style="color:var(--muted);">Hôm nay không có lớp.</p>';
          todayNote.textContent = ps.source ? `Nguồn dữ liệu: ${ps.source}` : '';
        }

        // Tuần này (đếm theo ngày)
        const weekWrap = document.getElementById('weekly-summary');
        if (ps.has_data && ps.counts_by_day) {
          weekWrap.innerHTML = daysOrder.map(d => {
            const cnt = ps.counts_by_day[d] || 0;
            return `
              <div title="${dayNames[d]}: ${cnt} lớp" style="min-width:120px; padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--panel); display:flex; flex-direction:column; align-items:center;">
                <div style="font-size:12px; color:var(--muted);">${dayNames[d]}</div>
                <div style="font-size:22px; font-weight:800; color:#2563eb;">${cnt}</div>
              </div>
            `;
          }).join('');
        } else {
          weekWrap.innerHTML = '<p style="color:var(--muted);">Chưa có dữ liệu cá nhân.</p>';
        }
      } catch (e) {
        console.error('Lỗi tải personal stats', e);
      }
      
      // Top recommendations
      const recContainer = document.getElementById('top-recommendations');
      if (stats.top_recommendations && stats.top_recommendations.length > 0) {
        recContainer.innerHTML = stats.top_recommendations.map((rec, idx) => `
          <div style="display:flex; align-items:center; justify-content:space-between; padding:10px; background:var(--panel); border-radius:8px; border:1px solid var(--border);">
            <div style="flex:1;">
              <div style="font-weight:600; color:var(--text);">${rec.course} - ${rec.subject}</div>
              <div style="font-size:12px; color:var(--muted); margin-top:2px;">Điểm AI: ${rec.score.toFixed(2)}</div>
            </div>
            <div style="background:#10b981; color:white; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600;">
              #${idx + 1}
            </div>
          </div>
        `).join('');
      } else {
        recContainer.innerHTML = '<p style="color:var(--muted); font-size:14px;">Chưa có dữ liệu gợi ý. Hãy chạy "Chạy gợi ý lớp" để xem.</p>';
      }
    } catch (e) {
      console.error('Lỗi tải stats:', e);
    }
  }

  // Job management
  async function post(url) {
    const res = await fetch(url, { method: 'POST' });
    if (!res.ok) throw new Error('Request failed');
    return await res.json();
  }

  async function get(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error('Request failed');
    return await res.json();
  }

  const btnRunSchedule = document.getElementById('btnRunSchedule');
  const btnRunRecommend = document.getElementById('btnRunRecommend');
  const btnRunRecommendSchedule = document.getElementById('btnRunRecommendSchedule');
  const jobIdInput = document.getElementById('jobId');
  const jobStatus = document.getElementById('jobStatus');
  const btnPoll = document.getElementById('btnPoll');
  const jobSection = document.getElementById('job-section');

  btnRunSchedule.addEventListener('click', async () => {
    btnRunSchedule.setAttribute('aria-busy', 'true');
    try {
      const data = await post('/run/schedule');
      jobIdInput.value = data.job_id;
      jobSection.style.display = 'block';
      await poll(data.job_id);
    } catch (e) {
      alert('Lỗi chạy sắp xếp');
    } finally {
      btnRunSchedule.removeAttribute('aria-busy');
    }
  });

  btnRunRecommend.addEventListener('click', async () => {
    btnRunRecommend.setAttribute('aria-busy', 'true');
    try {
      const data = await post(`/run/recommend`);
      jobIdInput.value = data.job_id;
      jobSection.style.display = 'block';
      await poll(data.job_id);
    } catch (e) {
      alert('Lỗi chạy gợi ý');
    } finally {
      btnRunRecommend.removeAttribute('aria-busy');
    }
  });

  btnRunRecommendSchedule.addEventListener('click', async () => {
    btnRunRecommendSchedule.setAttribute('aria-busy', 'true');
    try {
      const data = await post('/run/recommend_schedule');
      jobIdInput.value = data.job_id;
      jobSection.style.display = 'block';
      await poll(data.job_id);
    } catch (e) {
      alert('Lỗi tạo TKB gợi ý');
    } finally {
      btnRunRecommendSchedule.removeAttribute('aria-busy');
    }
  });

  btnPoll.addEventListener('click', async () => {
    const id = jobIdInput.value.trim();
    if (!id) return;
    jobSection.style.display = 'block';
    await poll(id);
  });

  async function poll(id) {
    jobStatus.textContent = 'Polling...';
    let stop = false;
    while (!stop) {
      const s = await get(`/status/${id}`);
      jobStatus.textContent = JSON.stringify(s, null, 2);
      if (s.status === 'completed' || s.status === 'failed') {
        stop = true;
        // Reload stats sau khi job hoàn thành
        if (s.status === 'completed') {
          setTimeout(loadStats, 1000);
        }
      }
      else await new Promise(r => setTimeout(r, 1500));
    }
  }

  // Load stats khi trang load
  loadStats();
</script>
{% endblock %}
